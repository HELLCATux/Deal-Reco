<!doctype html>
<html lang="en" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Deal Comparison Tool</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Space Grotesk', sans-serif;
    }

    .data-table {
      border-collapse: collapse;
      width: 100%;
    }

    .data-table th,
    .data-table td {
      padding: 4px 8px;
      text-align: left;
      border-bottom: 1px solid;
      word-wrap: break-word;
      max-width: 200px;
    }

    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .pulse-icon {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
  </style>
  <script src="https://cdn.tailwindcss.com/3.4.17" type="text/javascript"></script>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app-container" class="h-full overflow-auto p-4">
   <div class="max-w-7xl mx-auto">
    <header class="text-center mb-4">
     <h1 id="page-title" class="text-xl font-bold"></h1>
    </header>
    <div class="mb-4">
     <h2 class="text-lg font-bold mb-3 text-center">Outward &amp; Inward Flows</h2>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="outward-indus-card">
       <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="outward-indus-icon-bg">
         <svg class="w-4 h-4" id="outward-indus-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2m0 0v-8m0 8l-6-4m6 4l6-4" />
         </svg>
        </div>
        <h2 id="outward-indus-title" class="text-base font-semibold">Outward Indus</h2>
       </div>
       <div id="outward-indus-summary-container" class="mt-2 hidden fade-in">
        <div class="overflow-x-auto rounded-lg" id="outward-indus-summary-table" style="width: 100%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span id="outward-indus-row-count" class="text-xs opacity-70">No data loaded</span>
       </div>
      </div>
      <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="inward-indus-card">
       <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="inward-indus-icon-bg">
         <svg class="w-4 h-4" id="inward-indus-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m-7-7l7 7 7-7" />
         </svg>
        </div>
        <h2 id="inward-indus-title" class="text-base font-semibold">Inward Indus</h2>
       </div>
       <div id="inward-indus-summary-container" class="mt-2 hidden fade-in">
        <div class="overflow-x-auto rounded-lg" id="inward-indus-summary-table" style="width: 100%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span id="inward-indus-row-count" class="text-xs opacity-70">No data loaded</span>
       </div>
      </div>
      <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="purpose-card">
       <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="purpose-icon-bg">
         <svg class="w-4 h-4" id="purpose-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
         </svg>
        </div>
        <h2 id="purpose-title" class="text-base font-semibold">INDUSTT Purpose Count</h2>
       </div>
       <div id="purpose-summary-container" class="mt-2 hidden fade-in">
        <h3 class="text-xs font-semibold mb-1" id="purpose-summary-title">Count by Purpose (INDUSTT)</h3>
        <div class="overflow-x-auto rounded-lg" id="purpose-summary-table" style="width: 100%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span id="purpose-row-count" class="text-xs opacity-70">No data loaded</span>
       </div>
      </div>
     </div>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="outward-idfc-card">
       <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="outward-idfc-icon-bg">
         <svg class="w-4 h-4" id="outward-idfc-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2m0 0v-8m0 8l-6-4m6 4l6-4" />
         </svg>
        </div>
        <h2 id="outward-idfc-title" class="text-base font-semibold">Outward IDFC</h2>
       </div>
       <div id="outward-idfc-summary-container" class="mt-2 hidden fade-in">
        <div class="overflow-x-auto rounded-lg" id="outward-idfc-summary-table" style="width: 100%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span id="outward-idfc-row-count" class="text-xs opacity-70">No data loaded</span>
       </div>
      </div>
      <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="inward-idfc-card">
       <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="inward-idfc-icon-bg">
         <svg class="w-4 h-4" id="inward-idfc-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m-7-7l7 7 7-7" />
         </svg>
        </div>
        <h2 id="inward-idfc-title" class="text-base font-semibold">Inward IDFC</h2>
       </div>
       <div id="inward-idfc-summary-container" class="mt-2 hidden fade-in">
        <div class="overflow-x-auto rounded-lg" id="inward-idfc-summary-table" style="width: 100%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span id="inward-idfc-row-count" class="text-xs opacity-70">No data loaded</span>
       </div>
      </div>
      <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="purpose-idfc-card">
       <div class="flex items-center gap-2 mb-2">
        <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="purpose-idfc-icon-bg">
         <svg class="w-4 h-4" id="purpose-idfc-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
         </svg>
        </div>
        <h2 id="purpose-idfc-title" class="text-base font-semibold">IDFCTT Purpose Count</h2>
       </div>
       <div id="purpose-idfc-summary-container" class="mt-2 hidden fade-in">
        <h3 class="text-xs font-semibold mb-1" id="purpose-idfc-summary-title">Count by Purpose (IDFCTT)</h3>
        <div class="overflow-x-auto rounded-lg" id="purpose-idfc-summary-table" style="width: 100%;"></div>
       </div>
       <div class="flex items-center justify-between mt-2"><span id="purpose-idfc-row-count" class="text-xs opacity-70">No data loaded</span>
       </div>
      </div>
     </div>
    </div>
    <div class="mb-4">
     <div class="rounded-xl p-3 shadow-lg overflow-hidden" id="deal-maturity-card">
      <div class="flex items-center gap-2 mb-2">
       <div class="w-7 h-7 rounded-lg flex items-center justify-center" id="deal-maturity-icon-bg">
        <svg class="w-4 h-4" id="deal-maturity-icon" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
       </div>
       <h2 id="deal-maturity-title" class="text-base font-semibold">Deal Maturity</h2>
      </div>
      <div id="deal-maturity-summary-container" class="mt-2 hidden fade-in">
       <div class="overflow-x-auto rounded-lg" id="deal-maturity-summary-table" style="width: 100%;"></div>
      </div>
      <div class="flex items-center justify-between mt-2"><span id="deal-maturity-row-count" class="text-xs opacity-70">No data loaded</span>
      </div>
     </div>
    </div>
    <div class="mt-4 rounded-lg p-3 text-center" id="copy-section"><button id="copy-excel-btn" class="px-4 py-2 rounded-lg font-semibold transition-all text-sm" style="background-color: #10b981; color: white;"> ðŸ“‹ Copy Tables </button>
     <div id="copy-status" class="text-xs opacity-70 mt-2 hidden"></div>
    </div>
    <div class="mt-4 rounded-lg p-3 text-center" id="excel-upload-section">
     <h3 class="text-sm font-semibold mb-2" id="excel-upload-title">Upload Excel File</h3>
     <div class="flex flex-col items-center gap-2"><label for="excel-file-input" class="cursor-pointer">
       <div id="excel-upload-area" class="rounded-lg border-2 border-dashed p-3 flex items-center justify-center gap-2 transition-all hover:scale-102">
        <svg class="w-5 h-5 opacity-60" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
        </svg>
        <p class="text-xs font-medium">Click to Upload Excel (EON, Indus, IDFCTT sheets)</p>
       </div></label> <input type="file" id="excel-file-input" accept=".xlsx,.xls" class="hidden">
      <div id="excel-upload-status" class="text-xs opacity-70 hidden"></div>
     </div>
    </div>
   </div>
  </div>
  <script>
    const defaultConfig = {
      page_title: '@Pruthvi@ Deal Comparison Tool',
      eon_section_title: 'Eon Deal',
      indus_section_title: 'Indus Bank Deal',
      idfc_section_title: 'IDFCTT Bank Deal',
      background_color: '#f8fafc',
      surface_color: '#ffffff',
      text_color: '#1e293b',
      primary_action_color: '#3b82f6',
      secondary_action_color: '#64748b',
      font_family: 'Space Grotesk',
      font_size: 14
    };

    let config = { ...defaultConfig };
    let currentEonData = null;
    let currentIndusData = null;
    let currentIdfcData = null;

    let industtSummaryData = {};
    let idfcttSummaryData = {};
    let indusSummaryData = {};
    let idfcSummaryData = {};
    let eonOutwardData = {};
    let indusOutwardData = {};
    let eonOutwardIdfcData = {};
    let idfcOutwardData = {};
    let eonInwardData = {};
    let indusInwardData = {};
    let eonInwardIdfcData = {};
    let idfcInwardData = {};

    function parseExcelData(text) {
      const rows = text.trim().split(/\r?\n/);
      if (rows.length === 0) return null;
      return rows.map(row => row.split('\t').map(cell => cell.trim()));
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function adjustColor(hex, percent) {
      const num = parseInt(hex.replace('#', ''), 16);
      const amt = Math.round(2.55 * percent);
      const R = Math.min(255, Math.max(0, (num >> 16) + amt));
      const G = Math.min(255, Math.max(0, (num >> 8 & 0x00FF) + amt));
      const B = Math.min(255, Math.max(0, (num & 0x0000FF) + amt));
      return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
    }

    function createOutwardIndusTable(eonData, indusData) {
      if (!eonData || eonData.length <= 1 || !indusData || indusData.length <= 1) {
        return '<p class="text-xs opacity-70 p-2">Data incomplete</p>';
      }

      const eonHeaders = eonData[0].map(h => h.toUpperCase().trim());
      const indusHeaders = indusData[0].map(h => h.toUpperCase().trim());

      const eonFENameIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('NAME'));
      const eonAmountIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('AMOUNT'));
      const eonPurposeIndex = eonHeaders.findIndex(h => h.includes('PURPOSE'));
      const eonIssuerCodeIndex = eonHeaders.findIndex(h => h.includes('ISSUER') && h.includes('CODE'));
      const indusDealCcyIndex = indusHeaders.findIndex(h => h.includes('DEALT') && h.includes('CCY'));
      const indusDealtAmountIndex = indusHeaders.findIndex(h => h.includes('DEALT') && h.includes('AMOUNT'));
      const indusBaseDirectionIndex = indusHeaders.findIndex(h => h.includes('BASE') && h.includes('DIRECTION'));

      if (eonFENameIndex === -1 || eonAmountIndex === -1 || indusDealCcyIndex === -1 || indusDealtAmountIndex === -1 || indusBaseDirectionIndex === -1 || eonIssuerCodeIndex === -1) {
        return '<p class="text-xs opacity-70 p-2">Required columns not found</p>';
      }

      eonOutwardData = {};
      indusOutwardData = {};

      for (let i = 1; i < eonData.length; i++) {
        const issuerCode = (eonData[i][eonIssuerCodeIndex] || '').toUpperCase().trim();
        if (issuerCode !== 'INDUSTT') continue;
        
        const feName = eonData[i][eonFENameIndex] || 'Unknown';
        const amount = parseFloat(eonData[i][eonAmountIndex]) || 0;
        let purpose = (eonData[i][eonPurposeIndex] || '').toUpperCase().trim();
        if (purpose === 'SURRENDER') continue;
        
        if (!eonOutwardData[feName]) eonOutwardData[feName] = 0;
        eonOutwardData[feName] += amount;
      }

      for (let i = 1; i < indusData.length; i++) {
        const baseDirection = (indusData[i][indusBaseDirectionIndex] || '').toUpperCase().trim();
        if (!baseDirection.includes('BUY')) continue;
        
        const ccy = indusData[i][indusDealCcyIndex] || 'Unknown';
        const amount = parseFloat(indusData[i][indusDealtAmountIndex]) || 0;
        if (amount > 0) {
          if (!indusOutwardData[ccy]) indusOutwardData[ccy] = 0;
          indusOutwardData[ccy] += amount;
        }
      }

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">FE Name</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Eon</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">INDUS</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Difference</th>`;
      html += `</tr></thead><tbody>`;

      const allNames = [...new Set([...Object.keys(eonOutwardData), ...Object.keys(indusOutwardData)])].sort();

      let rowIndex = 0;
      for (const name of allNames) {
        const eonAmount = eonOutwardData[name] || 0;
        const bankAmount = indusOutwardData[name] || 0;
        const difference = eonAmount - bankAmount;

        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${escapeHtml(name)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${eonAmount.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${bankAmount.toLocaleString()}</td>`;

        const diffColor = difference < 0 ? '#ef4444' : difference > 0 ? '#10b981' : config.text_color;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${diffColor}; font-weight: ${difference !== 0 ? '600' : '400'};">${difference.toLocaleString()}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (allNames.length === 0) {
        html += `<tr><td colspan="4" style="text-align: center; padding: 10px; opacity: 0.7;">No data found</td></tr>`;
      }

      html += '</tbody></table>';
      return html;
    }

    function createInwardIndusTable(eonData, indusData) {
      if (!eonData || eonData.length <= 1 || !indusData || indusData.length <= 1) {
        return '<p class="text-xs opacity-70 p-2">Data incomplete</p>';
      }

      const eonHeaders = eonData[0].map(h => h.toUpperCase().trim());
      const indusHeaders = indusData[0].map(h => h.toUpperCase().trim());

      const eonFENameIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('NAME'));
      const eonAmountIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('AMOUNT'));
      const eonPurposeIndex = eonHeaders.findIndex(h => h.includes('PURPOSE'));
      const eonIssuerCodeIndex = eonHeaders.findIndex(h => h.includes('ISSUER') && h.includes('CODE'));
      const indusDealCcyIndex = indusHeaders.findIndex(h => h.includes('DEALT') && h.includes('CCY'));
      const indusDealtAmountIndex = indusHeaders.findIndex(h => h.includes('DEALT') && h.includes('AMOUNT'));
      const indusBaseDirectionIndex = indusHeaders.findIndex(h => h.includes('BASE') && h.includes('DIRECTION'));

      if (eonFENameIndex === -1 || eonAmountIndex === -1 || indusDealCcyIndex === -1 || indusDealtAmountIndex === -1 || indusBaseDirectionIndex === -1 || eonIssuerCodeIndex === -1) {
        return '<p class="text-xs opacity-70 p-2">Required columns not found</p>';
      }

      eonInwardData = {};
      indusInwardData = {};

      for (let i = 1; i < eonData.length; i++) {
        const issuerCode = (eonData[i][eonIssuerCodeIndex] || '').toUpperCase().trim();
        if (issuerCode !== 'INDUSTT') continue;
        
        const feName = eonData[i][eonFENameIndex] || 'Unknown';
        const amount = parseFloat(eonData[i][eonAmountIndex]) || 0;
        let purpose = (eonData[i][eonPurposeIndex] || '').toUpperCase().trim();
        if (purpose !== 'SURRENDER') continue;
        
        if (!eonInwardData[feName]) eonInwardData[feName] = 0;
        eonInwardData[feName] += amount;
      }

      for (let i = 1; i < indusData.length; i++) {
        const baseDirection = (indusData[i][indusBaseDirectionIndex] || '').toUpperCase().trim();
        if (!baseDirection.includes('SELL')) continue;
        
        const ccy = indusData[i][indusDealCcyIndex] || 'Unknown';
        const amount = parseFloat(indusData[i][indusDealtAmountIndex]) || 0;
        if (amount > 0) {
          if (!indusInwardData[ccy]) indusInwardData[ccy] = 0;
          indusInwardData[ccy] += amount;
        }
      }

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">FE Name</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Eon</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">INDUS</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Difference</th>`;
      html += `</tr></thead><tbody>`;

      const allNames = [...new Set([...Object.keys(eonInwardData), ...Object.keys(indusInwardData)])].sort();

      let rowIndex = 0;
      for (const name of allNames) {
        const eonAmount = eonInwardData[name] || 0;
        const bankAmount = indusInwardData[name] || 0;
        const difference = eonAmount - bankAmount;

        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${escapeHtml(name)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${eonAmount.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${bankAmount.toLocaleString()}</td>`;

        const diffColor = difference < 0 ? '#ef4444' : difference > 0 ? '#10b981' : config.text_color;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${diffColor}; font-weight: ${difference !== 0 ? '600' : '400'};">${difference.toLocaleString()}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (allNames.length === 0) {
        html += `<tr><td colspan="4" style="text-align: center; padding: 10px; opacity: 0.7;">No data found</td></tr>`;
      }

      html += '</tbody></table>';
      return html;
    }

    function createOutwardIdfcTable(eonData, idfcData) {
      if (!eonData || eonData.length <= 1 || !idfcData || idfcData.length <= 1) {
        return '<p class="text-xs opacity-70 p-2">Data incomplete</p>';
      }

      const eonHeaders = eonData[0].map(h => h.toUpperCase().trim());
      const idfcHeaders = idfcData[0].map(h => h.toUpperCase().trim());

      const eonFENameIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('NAME'));
      const eonAmountIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('AMOUNT'));
      const eonPurposeIndex = eonHeaders.findIndex(h => h.includes('PURPOSE'));
      const eonIssuerCodeIndex = eonHeaders.findIndex(h => h.includes('ISSUER') && h.includes('CODE'));
      const idfcCcyPairIndex = idfcHeaders.findIndex(h => h.includes('CCY') && h.includes('PAIR'));
      const idfcAmount1Index = idfcHeaders.findIndex(h => h.includes('AMOUNT') && h.includes('1'));
      const idfcBuySellIndex = idfcHeaders.findIndex(h => h.includes('BUY') || h.toUpperCase().includes('SELL'));

      if (eonFENameIndex === -1 || eonAmountIndex === -1 || idfcCcyPairIndex === -1 || idfcAmount1Index === -1 || idfcBuySellIndex === -1 || eonIssuerCodeIndex === -1) {
        return '<p class="text-xs opacity-70 p-2">Required columns not found</p>';
      }

      eonOutwardIdfcData = {};
      idfcOutwardData = {};

      for (let i = 1; i < eonData.length; i++) {
        const issuerCode = (eonData[i][eonIssuerCodeIndex] || '').toUpperCase().trim();
        if (issuerCode !== 'IDFCTT') continue;
        
        const feName = eonData[i][eonFENameIndex] || 'Unknown';
        const amount = parseFloat(eonData[i][eonAmountIndex]) || 0;
        let purpose = (eonData[i][eonPurposeIndex] || '').toUpperCase().trim();
        if (purpose === 'SURRENDER') continue;
        
        if (!eonOutwardIdfcData[feName]) eonOutwardIdfcData[feName] = 0;
        eonOutwardIdfcData[feName] += amount;
      }

      for (let i = 1; i < idfcData.length; i++) {
        const buySell = (idfcData[i][idfcBuySellIndex] || '').toUpperCase().trim();
        if (!buySell.includes('BUY')) continue;
        
        let ccyPair = (idfcData[i][idfcCcyPairIndex] || '').trim().toUpperCase();
        const amount1 = parseFloat(idfcData[i][idfcAmount1Index]) || 0;
        ccyPair = ccyPair.replace('INR', '');
        
        if (ccyPair.length === 3 && amount1 > 0) {
          if (!idfcOutwardData[ccyPair]) idfcOutwardData[ccyPair] = 0;
          idfcOutwardData[ccyPair] += amount1;
        }
      }

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">FE Name</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Eon</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">IDFC</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Difference</th>`;
      html += `</tr></thead><tbody>`;

      const allNames = [...new Set([...Object.keys(eonOutwardIdfcData), ...Object.keys(idfcOutwardData)])].sort();

      let rowIndex = 0;
      for (const name of allNames) {
        const eonAmount = eonOutwardIdfcData[name] || 0;
        const idfcAmount = idfcOutwardData[name] || 0;
        const difference = eonAmount - idfcAmount;

        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${escapeHtml(name)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${eonAmount.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${idfcAmount.toLocaleString()}</td>`;

        const diffColor = difference < 0 ? '#ef4444' : difference > 0 ? '#10b981' : config.text_color;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${diffColor}; font-weight: ${difference !== 0 ? '600' : '400'};">${difference.toLocaleString()}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (allNames.length === 0) {
        html += `<tr><td colspan="4" style="text-align: center; padding: 10px; opacity: 0.7;">No data found</td></tr>`;
      }

      html += '</tbody></table>';
      return html;
    }

    function createInwardIdfcTable(eonData, idfcData) {
      if (!eonData || eonData.length <= 1 || !idfcData || idfcData.length <= 1) {
        return '<p class="text-xs opacity-70 p-2">Data incomplete</p>';
      }

      const eonHeaders = eonData[0].map(h => h.toUpperCase().trim());
      const idfcHeaders = idfcData[0].map(h => h.toUpperCase().trim());

      const eonFENameIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('NAME'));
      const eonAmountIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('AMOUNT'));
      const eonPurposeIndex = eonHeaders.findIndex(h => h.includes('PURPOSE'));
      const eonIssuerCodeIndex = eonHeaders.findIndex(h => h.includes('ISSUER') && h.includes('CODE'));
      const idfcCcyPairIndex = idfcHeaders.findIndex(h => h.includes('CCY') && h.includes('PAIR'));
      const idfcAmount1Index = idfcHeaders.findIndex(h => h.includes('AMOUNT') && h.includes('1'));
      const idfcBuySellIndex = idfcHeaders.findIndex(h => h.includes('BUY') || h.toUpperCase().includes('SELL'));

      if (eonFENameIndex === -1 || eonAmountIndex === -1 || idfcCcyPairIndex === -1 || idfcAmount1Index === -1 || idfcBuySellIndex === -1 || eonIssuerCodeIndex === -1) {
        return '<p class="text-xs opacity-70 p-2">Required columns not found</p>';
      }

      eonInwardIdfcData = {};
      idfcInwardData = {};

      for (let i = 1; i < eonData.length; i++) {
        const issuerCode = (eonData[i][eonIssuerCodeIndex] || '').toUpperCase().trim();
        if (issuerCode !== 'IDFCTT') continue;
        
        const feName = eonData[i][eonFENameIndex] || 'Unknown';
        const amount = parseFloat(eonData[i][eonAmountIndex]) || 0;
        let purpose = (eonData[i][eonPurposeIndex] || '').toUpperCase().trim();
        if (purpose !== 'SURRENDER') continue;
        
        if (!eonInwardIdfcData[feName]) eonInwardIdfcData[feName] = 0;
        eonInwardIdfcData[feName] += amount;
      }

      for (let i = 1; i < idfcData.length; i++) {
        const buySell = (idfcData[i][idfcBuySellIndex] || '').toUpperCase().trim();
        if (!buySell.includes('SELL')) continue;
        
        let ccyPair = (idfcData[i][idfcCcyPairIndex] || '').trim().toUpperCase();
        const amount1 = parseFloat(idfcData[i][idfcAmount1Index]) || 0;
        ccyPair = ccyPair.replace('INR', '');
        
        if (ccyPair.length === 3 && amount1 > 0) {
          if (!idfcInwardData[ccyPair]) idfcInwardData[ccyPair] = 0;
          idfcInwardData[ccyPair] += amount1;
        }
      }

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">FE Name</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Eon</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">IDFC</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Difference</th>`;
      html += `</tr></thead><tbody>`;

      const allNames = [...new Set([...Object.keys(eonInwardIdfcData), ...Object.keys(idfcInwardData)])].sort();

      let rowIndex = 0;
      for (const name of allNames) {
        const eonAmount = eonInwardIdfcData[name] || 0;
        const idfcAmount = idfcInwardData[name] || 0;
        const difference = eonAmount - idfcAmount;

        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${escapeHtml(name)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${eonAmount.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${idfcAmount.toLocaleString()}</td>`;

        const diffColor = difference < 0 ? '#ef4444' : difference > 0 ? '#10b981' : config.text_color;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${diffColor}; font-weight: ${difference !== 0 ? '600' : '400'};">${difference.toLocaleString()}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (allNames.length === 0) {
        html += `<tr><td colspan="4" style="text-align: center; padding: 10px; opacity: 0.7;">No data found</td></tr>`;
      }

      html += '</tbody></table>';
      return html;
    }

    function createDealMaturityTable(data) {
      if (!data || data.length <= 1) return '';

      const headers = data[0].map(h => h.toUpperCase().trim());
      const feNameIndex = headers.findIndex(h => h.includes('FE') && h.includes('NAME'));
      const maturityIndex = headers.findIndex(h => h.includes('MATURITY'));
      const feAmountIndex = headers.findIndex(h => h.includes('FE') && h.includes('AMOUNT'));

      if (feNameIndex === -1 || maturityIndex === -1 || feAmountIndex === -1) {
        return '<p class="text-xs opacity-70 p-2">FE NAME, MATURITY, or FE AMOUNT column not found</p>';
      }

      const maturityData = {};
      let totalCash = 0, totalTom = 0, totalSpot = 0, totalFE = 0;
      let countCash = 0, countTom = 0, countSpot = 0;

      for (let i = 1; i < data.length; i++) {
        const feName = data[i][feNameIndex] || 'Unknown';
        let maturity = (data[i][maturityIndex] || '').toUpperCase().trim();
        const feAmount = parseFloat(data[i][feAmountIndex]) || 0;

        if (maturity.includes('CASH') || maturity === 'C') {
          maturity = 'Cash';
        } else if (maturity.includes('TOM') || maturity === 'T') {
          maturity = 'Tom';
        } else if (maturity.includes('SPOT') || maturity === 'S') {
          maturity = 'Spot';
        }

        if (!maturityData[feName]) {
          maturityData[feName] = { 'Cash': 0, 'Tom': 0, 'Spot': 0 };
        }

        if (maturityData[feName][maturity] !== undefined) {
          maturityData[feName][maturity] += feAmount;
        }

        if (maturity === 'Cash') {
          totalCash += feAmount;
          countCash++;
        } else if (maturity === 'Tom') {
          totalTom += feAmount;
          countTom++;
        } else if (maturity === 'Spot') {
          totalSpot += feAmount;
          countSpot++;
        }
      }

      totalFE = totalCash + totalTom + totalSpot;
      const totalCount = countCash + countTom + countSpot;

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.primary_action_color}; color: white; font-weight: 600;">FE Name</th>`;
      html += `<th style="background-color: ${config.primary_action_color}; color: white; font-weight: 600;">Cash</th>`;
      html += `<th style="background-color: ${config.primary_action_color}; color: white; font-weight: 600;">Tom</th>`;
      html += `<th style="background-color: ${config.primary_action_color}; color: white; font-weight: 600;">Spot</th>`;
      html += `<th style="background-color: ${config.primary_action_color}; color: white; font-weight: 600;">Total FE</th>`;
      html += `</tr></thead><tbody>`;

      const allNames = Object.keys(maturityData).sort();
      let rowIndex = 0;

      for (const name of allNames) {
        const cash = maturityData[name]['Cash'] || 0;
        const tom = maturityData[name]['Tom'] || 0;
        const spot = maturityData[name]['Spot'] || 0;
        const feTotal = cash + tom + spot;

        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${escapeHtml(name)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${cash.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${tom.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${spot.toLocaleString()}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}">${feTotal.toLocaleString()}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (allNames.length === 0) {
        html += `<tr><td colspan="5" style="text-align: center; padding: 10px; opacity: 0.7;">No data found</td></tr>`;
      } else {
        html += `<tr style="background-color: ${config.primary_action_color}; font-weight: 700;">`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">TOTAL</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${totalCash.toLocaleString()}</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${totalTom.toLocaleString()}</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${totalSpot.toLocaleString()}</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${totalFE.toLocaleString()}</td>`;
        html += `</tr>`;

        html += `<tr style="background-color: ${adjustColor(config.primary_action_color, -20)}; font-weight: 600;">`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">COUNT</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${countCash}</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${countTom}</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${countSpot}</td>`;
        html += `<td style="color: white; border-color: ${config.primary_action_color};">${totalCount}</td>`;
        html += `</tr>`;
      }

      html += '</tbody></table>';
      return html;
    }

    function createPurposeCountTable(data) {
      if (!data || data.length <= 1) return { html: '', totalCount: 0 };

      const headers = data[0].map(h => h.toUpperCase().trim());
      const purposeIndex = headers.findIndex(h => h.includes('PURPOSE'));
      const issuerCodeIndex = headers.findIndex(h => h.includes('ISSUER') && h.includes('CODE'));

      if (purposeIndex === -1 || issuerCodeIndex === -1) {
        return { html: '<p class="text-xs opacity-70 p-2">PURPOSE or ISSUER CODE column not found</p>', totalCount: 0 };
      }

      const purposeCount = {};
      let totalCount = 0;

      for (let i = 1; i < data.length; i++) {
        let purpose = data[i][purposeIndex] || 'Unknown';
        const issuerCode = (data[i][issuerCodeIndex] || '').toUpperCase().trim();

        let purposeUpper = purpose.toUpperCase().trim();
        if (purposeUpper === 'EDUCATION-WITH LOAN' || purposeUpper === 'EDUCATION') {
          purpose = 'EDUCATION';
        } else if (purposeUpper === 'REMTOUROPS-T') {
          purpose = 'TOURS';
        } else if (purposeUpper === 'REMTOUROPS-M') {
          purpose = 'MICE';
        } else if (purposeUpper === 'SURRENDER') {
          purpose = 'INWARD';
        }

        if (issuerCode === 'INDUSTT') {
          if (!purposeCount[purpose]) {
            purposeCount[purpose] = 0;
          }
          purposeCount[purpose]++;
          totalCount++;
        }
      }

      const inwardCount = purposeCount['INWARD'];
      delete purposeCount['INWARD'];

      const sortedPurposes = Object.entries(purposeCount).sort((a, b) => b[1] - a[1]);
      if (inwardCount !== undefined) {
        sortedPurposes.push(['INWARD', inwardCount]);
      }

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Purpose</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Count</th>`;
      html += `</tr></thead><tbody>`;

      let rowIndex = 0;
      for (const [purpose, count] of sortedPurposes) {
        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        const isInward = purpose === 'INWARD';
        const textColor = isInward ? '#ef4444' : config.text_color;
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${textColor};">${escapeHtml(purpose)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${textColor};">${count}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (sortedPurposes.length === 0) {
        html += `<tr><td colspan="2" style="text-align: center; padding: 10px; opacity: 0.7;">No INDUSTT data found</td></tr>`;
      } else {
        html += `<tr style="background-color: ${config.secondary_action_color}; font-weight: 700;">`;
        html += `<td style="color: white; border-color: ${config.secondary_action_color};">TOTAL</td>`;
        html += `<td style="color: white; border-color: ${config.secondary_action_color};">${totalCount}</td>`;
        html += `</tr>`;
      }

      html += '</tbody></table>';
      return { html, totalCount };
    }

    function createPurposeCountTableIdfc(data) {
      if (!data || data.length <= 1) return { html: '', totalCount: 0 };

      const headers = data[0].map(h => h.toUpperCase().trim());
      const purposeIndex = headers.findIndex(h => h.includes('PURPOSE'));
      const issuerCodeIndex = headers.findIndex(h => h.includes('ISSUER') && h.includes('CODE'));

      if (purposeIndex === -1 || issuerCodeIndex === -1) {
        return { html: '<p class="text-xs opacity-70 p-2">PURPOSE or ISSUER CODE column not found</p>', totalCount: 0 };
      }

      const purposeCount = {};
      let totalCount = 0;

      for (let i = 1; i < data.length; i++) {
        let purpose = data[i][purposeIndex] || 'Unknown';
        const issuerCode = (data[i][issuerCodeIndex] || '').toUpperCase().trim();

        const purposeUpper = purpose.toUpperCase().trim();
        if (purposeUpper === 'EDUCATION-WITH LOAN' || purposeUpper === 'EDUCATION') {
          purpose = 'EDUCATION';
        } else if (purposeUpper === 'REMTOUROPS-T') {
          purpose = 'TOURS';
        } else if (purposeUpper === 'REMTOUROPS-M') {
          purpose = 'MICE';
        } else if (purposeUpper === 'SURRENDER') {
          purpose = 'INWARD';
        }

        if (issuerCode === 'IDFCTT') {
          if (!purposeCount[purpose]) {
            purposeCount[purpose] = 0;
          }
          purposeCount[purpose]++;
          totalCount++;
        }
      }

      const sortedPurposes = Object.entries(purposeCount).sort((a, b) => b[1] - a[1]);

      let html = `<table class="data-table" style="color: ${config.text_color}; font-size: 0.875rem;">`;
      html += `<thead><tr>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Purpose</th>`;
      html += `<th style="background-color: ${config.secondary_action_color}; color: white; font-weight: 600;">Count</th>`;
      html += `</tr></thead><tbody>`;

      let rowIndex = 0;
      for (const [purpose, count] of sortedPurposes) {
        const rowBg = rowIndex % 2 === 0 ? config.surface_color : adjustColor(config.surface_color, 10);
        const isInward = purpose === 'INWARD';
        const textColor = isInward ? '#ef4444' : config.text_color;
        html += `<tr style="background-color: ${rowBg}">`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${textColor};">${escapeHtml(purpose)}</td>`;
        html += `<td style="border-color: ${adjustColor(config.surface_color, 20)}; color: ${textColor};">${count}</td>`;
        html += `</tr>`;
        rowIndex++;
      }

      if (sortedPurposes.length === 0) {
        html += `<tr><td colspan="2" style="text-align: center; padding: 10px; opacity: 0.7;">No IDFCTT data found</td></tr>`;
      } else {
        html += `<tr style="background-color: ${config.secondary_action_color}; font-weight: 700;">`;
        html += `<td style="color: white; border-color: ${config.secondary_action_color};">TOTAL</td>`;
        html += `<td style="color: white; border-color: ${config.secondary_action_color};">${totalCount}</td>`;
        html += `</tr>`;
      }

      html += '</tbody></table>';
      return { html, totalCount };
    }

    function getTableDataAsArray(tableId) {
      const table = document.getElementById(tableId);
      if (!table) return [];
      
      const rows = table.querySelectorAll('tr');
      const data = [];
      
      rows.forEach(row => {
        const cells = row.querySelectorAll('th, td');
        const rowData = [];
        cells.forEach(cell => {
          rowData.push(cell.textContent.trim());
        });
        if (rowData.length > 0) {
          data.push(rowData);
        }
      });
      
      return data;
    }

    function copyToClipboard() {
      const copyBtn = document.getElementById('copy-excel-btn');
      const copyStatus = document.getElementById('copy-status');
      
      copyBtn.disabled = true;
      copyStatus.classList.remove('hidden');
      copyStatus.textContent = 'â³ Copying to clipboard...';

      try {
        const outwardIndusData = getTableDataAsArray('outward-indus-summary-table');
        const outwardIdfcData = getTableDataAsArray('outward-idfc-summary-table');
        const dealMaturityData = getTableDataAsArray('deal-maturity-summary-table');

        let clipboardText = '';

        if (outwardIndusData.length > 0) {
          clipboardText += '=== OUTWARD INDUS ===\n';
          clipboardText += outwardIndusData.map(row => row.join('\t')).join('\n');
          clipboardText += '\n\n';
        }

        if (outwardIdfcData.length > 0) {
          clipboardText += '=== OUTWARD IDFC ===\n';
          clipboardText += outwardIdfcData.map(row => row.join('\t')).join('\n');
          clipboardText += '\n\n';
        }

        if (dealMaturityData.length > 0) {
          clipboardText += '=== DEAL MATURITY ===\n';
          clipboardText += dealMaturityData.map(row => row.join('\t')).join('\n');
        }

        navigator.clipboard.writeText(clipboardText).then(() => {
          copyStatus.textContent = 'âœ… Copied to clipboard! Ready to paste.';
          copyStatus.style.color = '#10b981';
          copyBtn.disabled = false;
          setTimeout(() => {
            copyStatus.classList.add('hidden');
          }, 3000);
        }).catch(error => {
          console.error('Error copying to clipboard:', error);
          copyStatus.textContent = 'âŒ Error copying to clipboard';
          copyStatus.style.color = '#ef4444';
          copyBtn.disabled = false;
          setTimeout(() => {
            copyStatus.classList.add('hidden');
          }, 3000);
        });
      } catch (error) {
        console.error('Error preparing data:', error);
        copyStatus.textContent = 'âŒ Error preparing data';
        copyStatus.style.color = '#ef4444';
        copyBtn.disabled = false;
        setTimeout(() => {
          copyStatus.classList.add('hidden');
        }, 3000);
      }
    }

    function regenerateOutwardIndusTable() {
      const outwardTable = document.getElementById('outward-indus-summary-table');
      const outwardContainer = document.getElementById('outward-indus-summary-container');
      const outwardRowCount = document.getElementById('outward-indus-row-count');
      if (!outwardTable || !outwardContainer) return;

      const html = createOutwardIndusTable(currentEonData, currentIndusData);
      outwardTable.innerHTML = html;
      outwardContainer.classList.remove('hidden');
      outwardRowCount.textContent = `${Object.keys(eonOutwardData).length + Object.keys(indusOutwardData).length} rows`;
    }

    function regenerateInwardIndusTable() {
      const inwardTable = document.getElementById('inward-indus-summary-table');
      const inwardContainer = document.getElementById('inward-indus-summary-container');
      const inwardRowCount = document.getElementById('inward-indus-row-count');
      if (!inwardTable || !inwardContainer) return;

      const html = createInwardIndusTable(currentEonData, currentIndusData);
      inwardTable.innerHTML = html;
      inwardContainer.classList.remove('hidden');
      inwardRowCount.textContent = `${Object.keys(eonInwardData).length + Object.keys(indusInwardData).length} rows`;
    }

    function regenerateOutwardIdfcTable() {
      const outwardTable = document.getElementById('outward-idfc-summary-table');
      const outwardContainer = document.getElementById('outward-idfc-summary-container');
      const outwardRowCount = document.getElementById('outward-idfc-row-count');
      if (!outwardTable || !outwardContainer) return;

      const html = createOutwardIdfcTable(currentEonData, currentIdfcData);
      outwardTable.innerHTML = html;
      outwardContainer.classList.remove('hidden');
      outwardRowCount.textContent = `${Object.keys(eonOutwardIdfcData).length + Object.keys(idfcOutwardData).length} rows`;
    }

    function regenerateInwardIdfcTable() {
      const inwardTable = document.getElementById('inward-idfc-summary-table');
      const inwardContainer = document.getElementById('inward-idfc-summary-container');
      const inwardRowCount = document.getElementById('inward-idfc-row-count');
      if (!inwardTable || !inwardContainer) return;

      const html = createInwardIdfcTable(currentEonData, currentIdfcData);
      inwardTable.innerHTML = html;
      inwardContainer.classList.remove('hidden');
      inwardRowCount.textContent = `${Object.keys(eonInwardIdfcData).length + Object.keys(idfcInwardData).length} rows`;
    }

    function regenerateDealMaturityTable() {
      const maturityTable = document.getElementById('deal-maturity-summary-table');
      const maturityContainer = document.getElementById('deal-maturity-summary-container');
      const maturityRowCount = document.getElementById('deal-maturity-row-count');
      if (!maturityTable || !maturityContainer || !currentEonData) return;

      const html = createDealMaturityTable(currentEonData);
      maturityTable.innerHTML = html;
      maturityContainer.classList.remove('hidden');
      
      const eonHeaders = currentEonData[0].map(h => h.toUpperCase().trim());
      const feNameIndex = eonHeaders.findIndex(h => h.includes('FE') && h.includes('NAME'));
      
      if (feNameIndex !== -1) {
        const uniqueFENames = new Set();
        for (let i = 1; i < currentEonData.length; i++) {
          uniqueFENames.add(currentEonData[i][feNameIndex]);
        }
        maturityRowCount.textContent = `${uniqueFENames.size} FE Names`;
      }
    }

    function setupExcelUpload() {
      const fileInput = document.getElementById('excel-file-input');
      const uploadArea = document.getElementById('excel-upload-area');

      fileInput.addEventListener('change', handleExcelFile);

      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = config.primary_action_color;
        uploadArea.style.transform = 'scale(1.02)';
      });

      uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = config.secondary_action_color;
        uploadArea.style.transform = 'scale(1)';
      });

      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = config.secondary_action_color;
        uploadArea.style.transform = 'scale(1)';

        const files = e.dataTransfer.files;
        if (files.length > 0) {
          fileInput.files = files;
          handleExcelFile({ target: { files: files } });
        }
      });
    }

    function handleExcelFile(e) {
      const file = e.target.files[0];
      const uploadStatus = document.getElementById('excel-upload-status');

      if (!file) return;

      uploadStatus.textContent = 'â³ Reading Excel file...';
      uploadStatus.classList.remove('hidden');
      uploadStatus.style.color = config.text_color;

      const reader = new FileReader();

      reader.onload = function(event) {
        try {
          const data = new Uint8Array(event.target.result);
          const workbook = XLSX.read(data, { type: 'array' });

          const eonSheetName = workbook.SheetNames.find(name => name.toUpperCase().includes('EON'));
          const indusSheetName = workbook.SheetNames.find(name => name.toUpperCase().includes('INDUS'));
          const idfcSheetName = workbook.SheetNames.find(name => name.toUpperCase().includes('IDFC'));

          if (!eonSheetName || !indusSheetName || !idfcSheetName) {
            uploadStatus.textContent = 'âŒ Excel file must have "EON", "Indus", and "IDFCTT" sheets';
            uploadStatus.style.color = '#ef4444';
            return;
          }

          const eonSheet = workbook.Sheets[eonSheetName];
          const eonData = XLSX.utils.sheet_to_json(eonSheet, { header: 1, defval: '' });

          const indusSheet = workbook.Sheets[indusSheetName];
          const indusData = XLSX.utils.sheet_to_json(indusSheet, { header: 1, defval: '' });

          const idfcSheet = workbook.Sheets[idfcSheetName];
          const idfcData = XLSX.utils.sheet_to_json(idfcSheet, { header: 1, defval: '' });

          if (eonData && eonData.length > 0) {
            loadEonData(eonData);
          }

          if (indusData && indusData.length > 0) {
            loadIndusData(indusData);
          }

          if (idfcData && idfcData.length > 0) {
            loadIdfcData(idfcData);
          }

          uploadStatus.textContent = `âœ… Loaded! (${eonData.length - 1} Eon, ${indusData.length - 1} Indus, ${idfcData.length - 1} IDFCTT rows)`;
          uploadStatus.style.color = '#10b981';

          e.target.value = '';

        } catch (error) {
          console.error('Error reading Excel file:', error);
          uploadStatus.textContent = 'âŒ Error reading Excel file. Please check the format.';
          uploadStatus.style.color = '#ef4444';
        }
      };

      reader.onerror = function() {
        uploadStatus.textContent = 'âŒ Error reading file';
        uploadStatus.style.color = '#ef4444';
      };

      reader.readAsArrayBuffer(file);
    }

    function loadEonData(data) {
      currentEonData = data;
      
      const purposeResult = createPurposeCountTable(data);
      const purposeSummaryTable = document.getElementById('purpose-summary-table');
      const purposeSummaryContainer = document.getElementById('purpose-summary-container');
      const purposeRowCount = document.getElementById('purpose-row-count');

      if (purposeSummaryTable && purposeSummaryContainer && purposeRowCount) {
        purposeSummaryTable.innerHTML = purposeResult.html;
        purposeSummaryContainer.classList.remove('hidden');
        purposeRowCount.textContent = `${purposeResult.totalCount} transactions`;
      }

      const purposeIdfcResult = createPurposeCountTableIdfc(data);
      const purposeIdfcSummaryTable = document.getElementById('purpose-idfc-summary-table');
      const purposeIdfcSummaryContainer = document.getElementById('purpose-idfc-summary-container');
      const purposeIdfcRowCount = document.getElementById('purpose-idfc-row-count');

      if (purposeIdfcSummaryTable && purposeIdfcSummaryContainer && purposeIdfcRowCount) {
        purposeIdfcSummaryTable.innerHTML = purposeIdfcResult.html;
        purposeIdfcSummaryContainer.classList.remove('hidden');
        purposeIdfcRowCount.textContent = `${purposeIdfcResult.totalCount} transactions`;
      }

      regenerateOutwardIndusTable();
      regenerateInwardIndusTable();
      regenerateOutwardIdfcTable();
      regenerateInwardIdfcTable();
      regenerateDealMaturityTable();
    }

    function loadIndusData(data) {
      currentIndusData = data;
      regenerateOutwardIndusTable();
      regenerateInwardIndusTable();
    }

    function loadIdfcData(data) {
      currentIdfcData = data;
      regenerateOutwardIdfcTable();
      regenerateInwardIdfcTable();
    }

    function applyConfig() {
      document.getElementById('page-title').textContent = config.page_title || defaultConfig.page_title;
      document.getElementById('app-container').style.backgroundColor = config.background_color || defaultConfig.background_color;
      document.getElementById('app-container').style.color = config.text_color || defaultConfig.text_color;
      document.getElementById('app-container').style.fontFamily = `${config.font_family}, sans-serif` || `${defaultConfig.font_family}, sans-serif`;
      document.getElementById('page-title').style.fontSize = `${(config.font_size || defaultConfig.font_size) * 1.5}px`;
    }

    // Initialize
    applyConfig();
    setupExcelUpload();
    document.getElementById('copy-excel-btn').addEventListener('click', copyToClipboard);
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ce2b3571794b2b1',t:'MTc3MTEzNjQzOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>